## 邮件

- 内置邮件。由系统触发，背包满发送邮件、任务完成未领取、排行榜结算奖励等
- 运营邮件。通过运营后台发送给全服或者某个玩家的邮件。

邮件可含有附件，包括道具、武器、装备等。设置了附件的邮件，玩家可以一次性获取奖励。

邮件具有失效性。邮件发出后多长时间内领取有效，过期删除。
邮件有数量限制。超过一定数目的邮件覆盖之前的（最早生成时间）。

已读、未读状态。无附件，点开过变为已读。有附件，领取后变成已读，即使点开过但未领取也是未读

## 设计实现

3个邮件队列。同一个邮件实例.

```
message Mail {
	optional string title      = 1; // 标题
	optional string sender     = 2; // 发送人
	optional int64  createTime = 3; // 创建时间
	optional int64  expireTime = 4; // 到期时间。
	optional string content    = 5; // 内容
	optional Award  awards     = 6; // 附件
	optional bool   read       = 7; // 已读状态
	required uint32 id         = 8; // 唯一ID
    optional bool   deleted    = 9; // 删除标记
}
```
#### 存储结构

1.玩家的邮件队列。玩家在线时由自身逻辑触发的。玩家可直接操作的队列（已读，删除）。

2.玩家的离线队列。一般由运维操作，也可能有一些战斗结算会推送到这里（例如多人副本但是中途掉线，副本完成时玩家不在线）。

3.全服邮件队列。由运维操作。

数据库表的存储结构含有 100 个槽位，每个槽位是一封邮件。需要3张表。

#### 工作流程

玩家登陆时，首先拉取自身的邮件队列，再拉取离线队列和全服队列中的邮件插入到玩家邮件队列中，并做好的标记（防止重复拉取）。

发送到全局邮件，将邮件插入到全局队列中，并通告全服在线玩家全局邮件队列中有新邮件了。不在线的玩家上线时通过上述流程拉取。

发送到玩家离线队列，流程同全局队列。

### 后记

全局队列的意义？为什么不直接发给所有玩家的离线队列中？

    是给全服玩家的邮件。否则就表示发给当前建号的玩家的邮件（有这种需求，在领取条件上做规则）。
    一定不能遍历玩家，容易增加事故概率，高成本低收益。

玩家离线队列和玩家自身队列共用一个？

    理论上是可以。在耦合度和实现复杂度上考虑。
    前者插入时按顺序插入即可，后者插入时有特定的覆盖规则。考虑运维发送邮件的情况，共用一个队列时，需要判断用户是否在线
    在线需发往对应的游戏服，由游戏服处理再存储，直接存储数据库将导致玩家内存数据和库中数据不一致。不在线时才能直接存数据库。
    而队列分开，两者处理逻辑更简单。虽然也会通知在线玩家拉取离线队列中邮件，但这一步不是必须的，玩家上线时仍然会拿到数据。




