
## 前言

游戏排行榜是每个游戏都必备的一个功能。
有日常常驻的排行榜，比如游戏的战力排行榜，游戏的财富排行榜，boss伤害排行榜等。

## 排行榜常见的功能

- 计算排名：排行榜中玩家数据一旦被更新，重新计算排名。
- 获取 top 数据：获取在当前排行榜中排名前 N 个的玩家数据，前100名玩家的详细数据。
- 支持自动定期重置或手动重置数据，比如在一个赛季结束之时或在指定天、周、月后自动重置排行榜，或是在应用测试阶段、应用数据出现误差的情况下进行手动重置。
- 获取当前玩家的排名：即使当前玩家没有名列前茅，也可以获取他在排行中的具体名次，以此了解到当前玩家和前排玩家的差距。
- 获取当前玩家附近排名的玩家：例如为当前玩家寻找水平相当的对手或好友。
- 更新模式：提供两种分数更新模式，better 保留玩家的最好成绩，last 保留玩家的最新成绩。

### 设计与实现

#### 排行榜算法

使用 `map` 和 `skiplist` 实现。
`skiplist` 跳表，它允许快速查询，插入和删除一个有序连续元素的数据链表。跳跃列表的平均查找和插入时间复杂度都是`O(logn)`。

自己写了一个算法 [sortedset](https://github.com/yddeng/sortedset) 
支持自定义排序规则，往往排序不只有一个 '分数' 作为规则。例如分数相同时，挑战时间早的排前或者等级高的排前。

#### 排行榜设计

- `RankID` 排行榜唯一标识。数据库会根据这个ID创建表。
- `BeginTime` 、`ExpireTime` 排行榜开始、结束时间。
- `Status` 排行榜状态。分为 未开始、开始、结算、结束 四个状态。

```
每一个排行榜实例，对应一张玩家数据表。由排行榜的生命周期 创建、删除玩家数据表

rank_list (排行榜数据)
id(榜实例ID), 
start_time(开始时间),
expire_time(结束时间),
status(排行榜状态),
settled_idx(结算时索引),
logic_addr(创建该榜的服逻辑地址）
    
rank_role_%d (根据已存在实例生成，删除。记录)
key(玩家ID),
score(分数),
role_info(玩家详细数据),
role_rank(排名)
        
```

玩家的排名只在内存中操作。排行榜进行中不会吧玩家排名写到数据库中，只有在排号榜结算阶段才写入排名
所以排行榜重启时，需要遍历玩家分数表重构排名数据。

玩家数据保存：定时存储 + 脏标记数量阀值 + 异步保存（每隔时间间隔或者脏数据达到一定数目开始写数据库，异步批量写入，不占用排行榜线程）
保存失败的数据添加回脏数据（不存在添加，已经存在不添加。可能为第二次的 setSroce 标记的脏数据，则不能覆盖）

排行榜各状态描述：
- 未开始。用户创建后未到开始时间。拒绝玩家设置分数，不可查看排名。
- 开始。排行榜进行，接受玩家设置分数，可查看排名。 
- 结算。到达结束时间。拒绝玩家设置分数，可查看排名。启动异步任务将内存中玩家的排名写入到数据库中，每写入一定数量的玩家将 `settled_idx` 更新。
    先写玩家排名再写结算索引。可能在结算过程中停服、宕机，重启后能保证继续结算不丢失。
    结算完成可事件通知到`game`服务器，让在线玩家拉取排名奖励。
- 结束。

#### 排行榜服务

排行榜服务上可允许多个排行榜，相互独立，独占一个线程。

服务启动时。排行榜状态为 开始，结算：需要重建排行榜数据。结算状态时还需要继续执行未写入的玩家排名。

服务停止时。拒绝所有请求，等待异步调用队列执行完成。等待各个 rank 脏数据落地；若在结算阶段，停止结算。


#### 排行榜API

1。创建排行榜 

单个创建者-单个服务：用户直接请求创建即可。

多个创建者-单个服务：会有多个创建者同时请求创建同一个排行榜，采用竞争的方式由服务处理，已经创建成功后向其他创建者返回状态，
由创建者直接处理该情况。

多个创建者-多个服务：多个创建者同时创建同一个排行榜请求到不同的服务上。情况和上面类似，但处理竞争的地方交给了数据库，
由数据库返回状态，插入成功该服务创建排行榜实体，失败返回给创建者排行榜已存在

2。设置分数 

根据更新模式出来分数。

better 需要判断当前分数是否比之前好，否则不处理。last 就直接更新

排行榜会直接返回设置后的排名，可实时查看。但是玩家的数据保存到数据库是异步的，有一定延迟。

3。获取前100排名 

能返回前100名的详细信息。

4。获取自身排名

自己的排名。可以根据总人数和排名计算百分比排名

#### 游戏服需要的配合

游戏服需要记录已经设置过分数的排行榜ID及地址。

收到排行榜服务排行榜结束的通知，游戏服遍历当前所有玩家，如果玩家有该排行榜的挑战记录，向排行榜拉取自己的排名并发放奖励。
排行榜服不通知状态呢，那玩家需要重新登陆上线时才能拉取到奖励。

玩家登陆时，根据已存在的记录到对应排行榜服务检查排行榜状态。
- 排行榜处于进行中、结算期，不做任何处理。
- 排行榜处于完结状态。根据检查结果（附带排名），给玩家发送奖励。移除或标记当前排行榜已经完结并发送了奖励。
- 排行榜已经不存在了。玩家很久没有上线，早期的排行榜已经清除了。删除当前排行榜记录，无奖励。

